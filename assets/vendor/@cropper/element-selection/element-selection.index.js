/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/@cropper/element-selection@2.0.0/dist/element-selection.esm.raw.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import t from"@cropper/element";import{CROPPER_SELECTION as i,EVENT_CHANGE as e,on as s,EVENT_KEYDOWN as h,off as n,isPositiveNumber as a,CROPPER_CANVAS as o,EVENT_ACTION_START as c,EVENT_ACTION_END as r,EVENT_ACTION as l,getAdjustedSizes as d,ACTION_SELECT as $,ACTION_SCALE as u,getOffset as v,ACTION_MOVE as g,ACTION_RESIZE_NORTHWEST as m,ACTION_RESIZE_SOUTHWEST as p,ACTION_RESIZE_NORTHEAST as b,ACTION_RESIZE_SOUTHEAST as f,isNumber as y,isPlainObject as w,CROPPER_IMAGE as k,isFunction as x,ACTION_RESIZE_WEST as A,ACTION_RESIZE_EAST as S,ACTION_RESIZE_SOUTH as C,ACTION_RESIZE_NORTH as D}from"@cropper/utils";const E=new WeakMap;class T extends t{constructor(){super(...arguments),this.$onCanvasAction=null,this.$onCanvasActionStart=null,this.$onCanvasActionEnd=null,this.$onDocumentKeyDown=null,this.$action="",this.$actionStartTarget=null,this.$changing=!1,this.$style=':host{display:block;left:0;position:relative;right:0}:host([outlined]){outline:1px solid var(--theme-color)}:host([multiple]){outline:1px dashed hsla(0,0%,100%,.5)}:host([multiple]):after{bottom:0;content:"";cursor:pointer;display:block;left:0;position:absolute;right:0;top:0}:host([multiple][active]){outline-color:var(--theme-color);z-index:1}:host([multiple])>*{visibility:hidden}:host([multiple][active])>*{visibility:visible}:host([multiple][active]):after{display:none}',this.$initialSelection={x:0,y:0,width:0,height:0},this.x=0,this.y=0,this.width=0,this.height=0,this.aspectRatio=NaN,this.initialAspectRatio=NaN,this.initialCoverage=NaN,this.active=!1,this.linked=!1,this.dynamic=!1,this.movable=!1,this.resizable=!1,this.zoomable=!1,this.multiple=!1,this.keyboard=!1,this.outlined=!1,this.precise=!1}set $canvas(t){E.set(this,t)}get $canvas(){return E.get(this)}static get observedAttributes(){return super.observedAttributes.concat(["active","aspect-ratio","dynamic","height","initial-aspect-ratio","initial-coverage","keyboard","linked","movable","multiple","outlined","precise","resizable","width","x","y","zoomable"])}$propertyChangedCallback(t,i,o){if(!Object.is(o,i))switch(super.$propertyChangedCallback(t,i,o),t){case"x":case"y":case"width":case"height":this.$changing||this.$nextTick((()=>{this.$change(this.x,this.y,this.width,this.height,this.aspectRatio,!0)}));break;case"aspectRatio":case"initialAspectRatio":this.$nextTick((()=>{this.$initSelection()}));break;case"initialCoverage":this.$nextTick((()=>{a(o)&&o<=1&&this.$initSelection(!0,!0)}));break;case"keyboard":this.$nextTick((()=>{this.$canvas&&(o?this.$onDocumentKeyDown||(this.$onDocumentKeyDown=this.$handleKeyDown.bind(this),s(this.ownerDocument,h,this.$onDocumentKeyDown)):this.$onDocumentKeyDown&&(n(this.ownerDocument,h,this.$onDocumentKeyDown),this.$onDocumentKeyDown=null))}));break;case"multiple":this.$nextTick((()=>{if(this.$canvas){const t=this.$getSelections();o?(t.forEach((t=>{t.active=!1})),this.active=!0,this.$emit(e,{x:this.x,y:this.y,width:this.width,height:this.height})):(this.active=!1,t.slice(1).forEach((t=>{this.$removeSelection(t)})))}}));break;case"precise":this.$nextTick((()=>{this.$change(this.x,this.y)}));break;case"linked":o&&(this.dynamic=!0)}}connectedCallback(){super.connectedCallback();const t=this.closest(this.$getTagNameOf(o));t?(this.$canvas=t,this.$setStyles({position:"absolute",transform:`translate(${this.x}px, ${this.y}px)`}),this.hidden||this.$render(),this.$initSelection(!0),this.$onCanvasActionStart=this.$handleActionStart.bind(this),this.$onCanvasActionEnd=this.$handleActionEnd.bind(this),this.$onCanvasAction=this.$handleAction.bind(this),s(t,c,this.$onCanvasActionStart),s(t,r,this.$onCanvasActionEnd),s(t,l,this.$onCanvasAction)):this.$render()}disconnectedCallback(){const{$canvas:t}=this;t&&(this.$onCanvasActionStart&&(n(t,c,this.$onCanvasActionStart),this.$onCanvasActionStart=null),this.$onCanvasActionEnd&&(n(t,r,this.$onCanvasActionEnd),this.$onCanvasActionEnd=null),this.$onCanvasAction&&(n(t,l,this.$onCanvasAction),this.$onCanvasAction=null)),super.disconnectedCallback()}$getSelections(){let t=[];return this.parentElement&&(t=Array.from(this.parentElement.querySelectorAll(this.$getTagNameOf(i)))),t}$initSelection(t=!1,i=!1){const{initialCoverage:e,parentElement:s}=this;if(a(e)&&s){const h=this.aspectRatio||this.initialAspectRatio;let n=(i?0:this.width)||s.offsetWidth*e,o=(i?0:this.height)||s.offsetHeight*e;a(h)&&({width:n,height:o}=d({aspectRatio:h,width:n,height:o})),this.$change(this.x,this.y,n,o),t&&this.$center(),this.$initialSelection={x:this.x,y:this.y,width:this.width,height:this.height}}}$createSelection(){const t=this.cloneNode(!0);return this.hasAttribute("id")&&t.removeAttribute("id"),t.initialCoverage=NaN,this.active=!1,this.parentElement&&this.parentElement.insertBefore(t,this.nextSibling),t}$removeSelection(t=this){if(this.parentElement){const i=this.$getSelections();if(i.length>1){const s=i.indexOf(t),h=i[s+1]||i[s-1];h&&(t.active=!1,this.parentElement.removeChild(t),h.active=!0,h.$emit(e,{x:h.x,y:h.y,width:h.width,height:h.height}))}else this.$clear()}}$handleActionStart(t){var i,s;const h=null===(s=null===(i=t.detail)||void 0===i?void 0:i.relatedEvent)||void 0===s?void 0:s.target;this.$action="",this.$actionStartTarget=h,!this.hidden&&this.multiple&&!this.active&&h===this&&this.parentElement&&(this.$getSelections().forEach((t=>{t.active=!1})),this.active=!0,this.$emit(e,{x:this.x,y:this.y,width:this.width,height:this.height}))}$handleAction(t){const{currentTarget:i,detail:e}=t;if(!i||!e)return;const{relatedEvent:s}=e;let{action:h}=e;if(!h&&this.multiple&&(h=this.$action||(null==s?void 0:s.target.action),this.$action=h),!h||this.hidden&&h!==$||this.multiple&&!this.active&&h!==u)return;const n=e.endX-e.startX,o=e.endY-e.startY,{width:c,height:r}=this;let{aspectRatio:l}=this;switch(!a(l)&&s.shiftKey&&(l=a(c)&&a(r)?c/r:1),h){case $:if(0!==n&&0!==o){const{$canvas:t}=this,s=v(i);(this.multiple&&!this.hidden?this.$createSelection():this).$change(e.startX-s.left,e.startY-s.top,Math.abs(n),Math.abs(o),l),n<0?o<0?h=m:o>0&&(h=p):n>0&&(o<0?h=b:o>0&&(h=f)),t&&(t.$action=h)}break;case g:this.movable&&(this.dynamic||this.$actionStartTarget&&this.contains(this.$actionStartTarget))&&this.$move(n,o);break;case u:if(s&&this.zoomable&&(this.dynamic||this.contains(s.target))){const t=v(i);this.$zoom(e.scale,s.pageX-t.left,s.pageY-t.top)}break;default:this.$resize(h,n,o,l)}}$handleActionEnd(){this.$action="",this.$actionStartTarget=null}$handleKeyDown(t){if(this.hidden||!this.keyboard||this.multiple&&!this.active||t.defaultPrevented)return;const{activeElement:i}=document;if(!i||!["INPUT","TEXTAREA"].includes(i.tagName)&&!["true","plaintext-only"].includes(i.contentEditable))switch(t.key){case"Backspace":t.metaKey&&(t.preventDefault(),this.$removeSelection());break;case"Delete":t.preventDefault(),this.$removeSelection();break;case"ArrowLeft":t.preventDefault(),this.$move(-1,0);break;case"ArrowRight":t.preventDefault(),this.$move(1,0);break;case"ArrowUp":t.preventDefault(),this.$move(0,-1);break;case"ArrowDown":t.preventDefault(),this.$move(0,1);break;case"+":t.preventDefault(),this.$zoom(.1);break;case"-":t.preventDefault(),this.$zoom(-.1)}}$center(){const{parentElement:t}=this;if(!t)return this;const i=(t.offsetWidth-this.width)/2,e=(t.offsetHeight-this.height)/2;return this.$change(i,e)}$move(t,i=t){return this.$moveTo(this.x+t,this.y+i)}$moveTo(t,i=t){return this.movable?this.$change(t,i):this}$resize(t,i=0,e=0,s=this.aspectRatio){if(!this.resizable)return this;const h=a(s),{$canvas:n}=this;let{x:o,y:c,width:r,height:l}=this;switch(t){case D:c+=e,l-=e,l<0&&(t=C,l=-l,c-=l),h&&(o+=(i=e*s)/2,r-=i,r<0&&(r=-r,o-=r));break;case S:r+=i,r<0&&(t=A,r=-r,o-=r),h&&(c-=(e=i/s)/2,l+=e,l<0&&(l=-l,c-=l));break;case C:l+=e,l<0&&(t=D,l=-l,c-=l),h&&(o-=(i=e*s)/2,r+=i,r<0&&(r=-r,o-=r));break;case A:o+=i,r-=i,r<0&&(t=S,r=-r,o-=r),h&&(c+=(e=i/s)/2,l-=e,l<0&&(l=-l,c-=l));break;case b:h&&(e=-i/s),c+=e,l-=e,r+=i,r<0&&l<0?(t=p,r=-r,l=-l,o-=r,c-=l):r<0?(t=m,r=-r,o-=r):l<0&&(t=f,l=-l,c-=l);break;case m:h&&(e=i/s),o+=i,c+=e,r-=i,l-=e,r<0&&l<0?(t=f,r=-r,l=-l,o-=r,c-=l):r<0?(t=b,r=-r,o-=r):l<0&&(t=p,l=-l,c-=l);break;case f:h&&(e=i/s),r+=i,l+=e,r<0&&l<0?(t=m,r=-r,l=-l,o-=r,c-=l):r<0?(t=p,r=-r,o-=r):l<0&&(t=b,l=-l,c-=l);break;case p:h&&(e=-i/s),o+=i,r-=i,l+=e,r<0&&l<0?(t=b,r=-r,l=-l,o-=r,c-=l):r<0?(t=f,r=-r,o-=r):l<0&&(t=m,l=-l,c-=l)}return n&&n.$setAction(t),this.$change(o,c,r,l)}$zoom(t,i,e){if(!this.zoomable||0===t)return this;t<0?t=1/(1-t):t+=1;const{width:s,height:h}=this,n=s*t,a=h*t;let o=this.x,c=this.y;return y(i)&&y(e)?(o-=(n-s)*((i-this.x)/s),c-=(a-h)*((e-this.y)/h)):(o-=(n-s)/2,c-=(a-h)/2),this.$change(o,c,n,a)}$change(t,i,s=this.width,h=this.height,n=this.aspectRatio,o=!1){return this.$changing||!y(t)||!y(i)||!y(s)||!y(h)||s<0||h<0?this:(a(n)&&({width:s,height:h}=d({aspectRatio:n,width:s,height:h},"cover")),this.precise||(t=Math.round(t),i=Math.round(i),s=Math.round(s),h=Math.round(h)),t===this.x&&i===this.y&&s===this.width&&h===this.height&&Object.is(n,this.aspectRatio)&&!o?this:(this.hidden&&(this.hidden=!1),!1===this.$emit(e,{x:t,y:i,width:s,height:h})?this:(this.$changing=!0,this.x=t,this.y=i,this.width=s,this.height=h,this.$changing=!1,this.$render())))}$reset(){const{x:t,y:i,width:e,height:s}=this.$initialSelection;return this.$change(t,i,e,s)}$clear(){return this.$change(0,0,0,0,NaN,!0),this.hidden=!0,this}$render(){return this.$setStyles({transform:`translate(${this.x}px, ${this.y}px)`,width:this.width,height:this.height})}$toCanvas(t){return new Promise(((i,e)=>{if(!this.isConnected)return void e(new Error("The current element is not connected to the DOM."));const s=document.createElement("canvas");let{width:h,height:n}=this,o=1;if(w(t)&&(a(t.width)||a(t.height))&&(({width:h,height:n}=d({aspectRatio:h/n,width:t.width,height:t.height})),o=h/this.width),s.width=h,s.height=n,!this.$canvas)return void i(s);const c=this.$canvas.querySelector(this.$getTagNameOf(k));c?c.$ready().then((e=>{const a=s.getContext("2d");if(a){const[i,r,l,d,$,u]=c.$getTransform(),v=-this.x,g=-this.y,m=(v*d-l*g)/(i*d-l*r),p=(g*i-r*v)/(i*d-l*r);let b=i*m+l*p+$,f=r*m+d*p+u,y=e.naturalWidth,k=e.naturalHeight;1!==o&&(b*=o,f*=o,y*=o,k*=o);const A=y/2,S=k/2;a.fillStyle="transparent",a.fillRect(0,0,h,n),w(t)&&x(t.beforeDraw)&&t.beforeDraw.call(this,a,s),a.save(),a.translate(A,S),a.transform(i,r,l,d,b,f),a.translate(-A,-S),a.drawImage(e,0,0,y,k),a.restore()}i(s)})).catch(e):i(s)}))}}T.$name=i,T.$version="2.0.0";export{T as default};
